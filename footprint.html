<!doctype html>
<html lang="en">
  <head>
    <style>
    div {
        font-size: 15px;
    }
    input {
        vertical-align: middle; 
    }
    .svgbg {
        border-style: solid;
        border-width: 1px;
        border-radius: 3px;
        border-color: #ccc; 
        height: 790px;
    }
    .arrow0 {
        fill:none;
        stroke:black;
    } 
    .arrow1 {
        fill:none;
        stroke:red;
    }
    </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="http://d3js.org/d3.v5.min.js"></script>

    <title>Dashboard Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="asset/bootstrap.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="asset/dashboard.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    
    <!-- Code renderer highlight.js -->
    <link rel="stylesheet" href="asset/highlight/styles/androidstudio.css">
    <script src="asset/highlight/highlight.pack.js"></script>

    <script>
            $(document).ready(function(){
                
                $("#alarm").load("alarm.out");
                
                $('#log pre code').each(function(i, block) {
                  hljs.highlightBlock();
                })

            });

            </script>
    <script>
    /* setTimeout(function() {
        hljs.initHighlightingOnLoad()
    }, 1000); */
    //hljs.initHighlightingOnLoad();
    </script>
  </head>

  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-1 mr-0" href="#">Footprint v0.1</a>
      <div class="form-control form-control-dark w-100 p-0"></div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-1 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="#">
                  <span data-feather="home"></span>
                  Dashboard <span class="sr-only">(current)</span>
                </a>
              </li>
              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Vis Options</span>
              </h6>
              <li class="nav-item">
                <a id="graphrender" class="nav-link" href="#">
                  <span data-feather="bar-chart-2"></span>
                  Render Graph
                </a>
              </li>
              <li class="nav-item">
                <a id="readalarm" class="nav-link" href="#">
                  <span data-feather="check"></span>
                  Read Alarm 
                </a>
              </li>
              <li class="nav-item">
                <a id="viewlog" class="nav-link" href="#">
                    <span data-feather="file"></span>
                    View All Log
                </a>
              </li> 
            </ul>

            <ul class="nav flex-column mb-2">
              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Debug Options</span>
              </h6>
              <li class="nav-item">
                <span class="nav-link" style="margin-bottom:-10px;">
                  <label><input id="dugchk" type="checkbox" onclick="toggleDug()" />&nbsp;&nbsp;Def-Use</label>
                </span>
              </li>
              <li class="nav-item">
                <span class="nav-link">
                  <label><input type="checkbox" />&nbsp;&nbsp;Rank</label>
                </span>
              </li>
            </ul>
          </div>
        </nav>

        <main role="main" class="col-md-11 ml-sm-auto col-lg-11 pt-3 px-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom" style="margin-left:-15px;">
            <div class="col-md-6">
              <h1 class="h2">CFG Panel</h1>
            </div>
            <div class="col-md-6" style="margin-left:15px;">
              <h1 class="h2">Log Panel</h1>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 svgbg" id="cfg">
                <button id="home" style="border-radius:4px; width:40px; height:40px; margin-top:15px;"><span data-feather="home"></span></button>
                <button id="zoom_in" style="border-radius:4px; width:40px; height:40px; margin-top:15px;"><span data-feather="plus"></span></button>
                <button id="zoom_out" style="border-radius:4px; width:40px; height:40px; margin-top:15px;"><span data-feather="minus"></span></button>
                <div id="dugon" style="float:right; border-radius:4px; background-color:#eee; border-color:#ccc; border-style:solid; border-width:1px; width:130px; height:50px; margin-top:15px; padding-left:5px; display:none;">
                    <span data-feather="arrow-right"></span>&nbsp;Control Flow</br>
                    <span data-feather="arrow-right" style="color:red;"></span>&nbsp;<span style="color:red;">Def-Use Chain</span>
                </div>
                <div id="dugoff" style="float:right; border-radius:4px; background-color:#eee; border-color:#ccc; border-style:solid; border-width:1px; width:130px; height:28px; margin-top:15px; padding-left:5px; display:inline;">
                    <span data-feather="arrow-right"></span>&nbsp;Control Flow</br>
                </div>
            </div>
            <div class="col-md-6" id="log">
              <div class="tab" style="height:40px;">
                <button class="tablinks" onclick="changeTab(event, 'atab')" style="font-size:large; width:50%; transform:translate(0%,-13%);">Alarm</button>
                <button class="tablinks" onclick="changeTab(event, 'ltab')" style="font-size:large; width:50%; transform:translate(0%,-13%);">Log</button>
              </div>
              <div id="atab" class="tabcontent">
                <pre><code id="alarm" class="hljs cpp">
                </code></pre>
              </div>
              <div id="ltab" class="tabcontent" style="display: none; overflow-y: scroll; height: 750px;">
              </div>
            </div>
          </div>
        
        </main>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="assets/jquery-slim.min.js"><\/script>')</script> -->
    <script src="asset/popper.min.js"></script>
    <script src="asset/bootstrap.min.css"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
      feather.replace()
    </script>

    <!-- Graphs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <script>
    let width = 960;
    let height = 500;
    let cfgs = []; // 파싱된 CallGraph의 CFG 이름들
    let cfgStatus; // 현재 CFG Panel에 렌더링하고 있는 그래프 이름. (CallGraph는 cg)

    let graph2nodes = function(gr){
    // 그래프 타입 배열을 노드 타입 배열로 변환
        let nodes = [];
        for(i in gr["nodes"]){
            nodes.push({"id":i, "stmt":gr["nodes"][i][0]});
        }
        return nodes;
    }

    let graph2cgnodes = function(gr){
    // 그래프 타입 배열을 노드 타입 배열로 변환
        let nodes = [];
        for(i in gr["nodes"]){
            nodes.push({"id":gr["nodes"][i], "stmt":gr["nodes"][i]});
        }
        return nodes;
    }

    let graph2links = function(gr){
    // 그래프 타입 배열을 링크 타입 배열로 변환
        let links = [];
        for(i in gr["edges"]){
            links.push({"source":gr["edges"][i][0], "target":gr["edges"][i][1], "text":""});
        }
        return links;
    }

    let getCfgNames = function(gr){
    // 그래프 타입 배열을 링크 타입 배열로 변환
        let names = [];
        for(i in gr["cfgs"]){
            names.push(i);
        }
        return names;
    }

    let hasCfgName = function(cfgs, cname){
    // CFG 이름 리스트에서 cname이 존재하는지 확인
        for(i in cfgs){
            if(cfgs[i]===cname) return true;
        }
        return false;
    }

    let svg = d3.selectAll("#cfg").append("svg")
      .attr("width", "100%")
      .attr("height", "720px");

    let dugOn; // Def-Use 토글 옵션 체크박스

    d3.json("json/a(with dug).json")
        .then(function(data){
            // 초기 데이터 엔트리
            renderCfg(data, "cg", false);
        });

    // CFG 그래프 렌더링 용 변수들
    let graph;
    let nodes;
    let links;
    let simulation;

    let g;
    let link;
    let node;

    let drag_handler;
    let text;

    // 줌 관련 렌더링 변수들
    let min_zoom;
    let max_zoom;
    let zoom_handler;

    let getDugChain = function(data, cid){

        let dugChain = data["dugraph"]["edges"];

        let curChain = [];
        for(i in dugChain){
            if(dugChain[i][0].substring(0, cid.length) === cid){
            // DUG 체인이 현재 렌더링된 그래프에 해당될 때
                let src = dugChain[i][0].substring(dugChain[i][0].indexOf('\-')+1);
                let tgt = dugChain[i][1].substring(dugChain[i][1].indexOf('\-')+1);
                let txt = dugChain[i][2];
                curChain.push({"source":src, "target":tgt, "text":txt});
            }
        }

        return curChain;

        /* link = g.append("g")
            .attr("class", "links")
            .selectAll("path")
            .data(curChain)
            .enter().append("path")
            .attr("stroke", function(d) { return d3.color("#FF0000"); })
            .attr("marker-end", "url(#arrow)"); */

    }

    let renderCfg = function(data, cid, dugbtn){

        cfgStatus = cid; // 해당 선택된 CFG 렌더링

        d3.selectAll("g").remove().exit().data(data);

        cfgs = getCfgNames(data);
        if(cid === "cg") {
            graph = data["callgraph"];
            nodes = graph2cgnodes(graph);
        } else { 
            graph = data["cfgs"][cid];        
            nodes = graph2nodes(graph);
        }
        links = graph2links(graph)
        if(dugbtn === true){
            let duLst = getDugChain(data, cid);
            links = links.concat(duLst);
        }

        simulation = d3.forceSimulation()
            .nodes(nodes);                          

        simulation
            .force("charge_force", d3.forceManyBody().strength(-100))    
            .force("center_force", d3.forceCenter(width / 2, height / 2))
            .force("links", d3.forceLink(links).id(function (d) { 
                return d.id; }))            
            .force("collide", d3.forceCollide().radius(2))
            ;         

        simulation
            .on("tick", ticked);

        

        //add encompassing group for the zoom 
        g = svg.append("g")
            .attr("class", "everything");

        //Create deffinition for the arrow markers showing relationship directions
        g.append("defs").append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -3 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("markerWidth", 8)
            .attr("markerHeight", 8)
            .attr("orient", "auto")
            .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");        

        link = g.append("g")
            .attr("class", "links")
            .selectAll("path")
            .data(links)
            .enter().append("path")
            .attr("class", function(d) {
                if(d.text === "") return "arrow0";
                else return "arrow1"; })
            .attr("stroke", function(d) { 
                if(d.text === "") return d3.color("#000000");
                else return d3.color("#FF0000"); })
            .attr("marker-end", "url(#arrow)");
            //#arrow" + d["value"] + "

        node = g.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("circle")
            .attr("r", 10)
            .attr("fill", function(d) { 
                /* if (d.sourceOnly) return d3.color("#0000FF"); */
                return d3.color("#FFFF2F"); })
            //.attr("id", "1")
            .style("stroke", function(d) { 
                /* if (d.sourceOnly) return d3.color("#000080"); */
                return d3.color("#FF8D2F"); 
            });

        //add drag capabilities  
        drag_handler = d3.drag()
            .on("start", drag_start)
            .on("drag", drag_drag)
            .on("end", drag_end);	

        drag_handler(node);

        text = g.append("g").attr("class", "labels").selectAll("g")
            .data(nodes)
            .enter().append("g")
            .append("text")
            .attr("x", 14)
            .attr("y", ".31em")
            .style("font-family", "sans-serif")
            .style("font-size", "0.7em")
            .text(function (d) { return d.id + ":" + d.stmt; });

        node.on("click", function (d) {
            
            if(hasCfgName(cfgs, d.id)){
                let dugOn = document.getElementById("dugchk");
                d3.json("json/a(with dug).json")
                .then(function(data){
                    renderCfg(data, d.id, dugOn.checked);
                });
            } else {
                d3.event.stopImmediatePropagation();
                self.onNodeClicked.emit(d.id);
            }
            
        });

        node.append("title")
            .text(function (d) { return d.id + ":" + d.stmt; });
        
        min_zoom = 0.5;
        max_zoom = 5;

        //add zoom capabilities 
        zoom_handler = d3.zoom().scaleExtent([min_zoom,max_zoom])
            .on("zoom", zoom_actions);

        zoom_handler(svg); 

        //Drag functions 
        //d is the node 
        function drag_start(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        //make sure you can't drag the circle outside the box
        function drag_drag(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }
        
        function drag_end(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        //Zoom functions 
        function zoom_actions(){
            g.attr("transform", d3.event.transform)
        }

        function ticked() {
            //update circle positions each tick of the simulation 
            node
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
                
            //update link positions 
            /* link
                .attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; }); */

            link.attr("d", function(d) {
                var dx = d.target.x - d.source.x,
                    dy = d.target.y - d.source.y,
                    dr;  //linknum is defined above
                    if(d.text === "") dr = 0;
                    else dr = 50;
                return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
            });

            text
                .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
        }


    }

    document.getElementById("viewlog").onclick = function() {
        changeTab(window.event, 'ltab');
    };

    document.getElementById("readalarm").onclick = function() {
        changeTab(window.event, 'atab');
    };

    document.getElementById("graphrender").onclick = function() {
        // 초기 CallGraph 렌더링하기

        cfgStatus = "cg";        
        dugOn = document.getElementById("dugchk");

        d3.json("json/a(with dug).json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, "cg", dugOn.checked);
            });

    };

    document.getElementById("home").onclick = function() {
        // 초기 CallGraph 렌더링하기

        cfgStatus = "cg";        
        dugOn = document.getElementById("dugchk");

        d3.json("json/a(with dug).json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, "cg", dugOn.checked);
            });

    };

    // HTML 패널 이벤트 관련 함수들
    function changeTab(evt, tabName) {
        var i, tabcontent, tablinks;

        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function toggleDug() {
        // 체크박스 확인해서 텍스트 박스 켜고 끔
        dugOn = document.getElementById("dugchk");
        let dugOnTxt = document.getElementById("dugon");
        let dugOffTxt = document.getElementById("dugoff");

        if (dugOn.checked == true){
            dugOnTxt.style.display = "inline";
            dugOffTxt.style.display = "none";

            d3.json("json/a(with dug).json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, cfgStatus, true);
            });

        } else {
            dugOnTxt.style.display = "none";
            dugOffTxt.style.display = "inline";

            d3.json("json/a(with dug).json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, cfgStatus, false);
            });

        }
    }

    </script>
  </body>
</html>
