<!doctype html>
<html lang="en">
  <head>
    <style>
    div {
        font-size: 15px;
    }
    input {
        vertical-align: middle; 
    }
    </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="http://d3js.org/d3.v5.min.js"></script>

    <title>Dashboard Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="asset/bootstrap.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="asset/dashboard.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    
    <!-- Code renderer highlight.js -->
    <link rel="stylesheet" href="asset/highlight/styles/androidstudio.css">
    <script src="asset/highlight/highlight.pack.js"></script>

    <script>
            $(document).ready(function(){
                
                $("#alarm").load("alarm.out");
                
                $('#log pre code').each(function(i, block) {
                  hljs.highlightBlock();
                })

            });

            </script>
    <script>
    /* setTimeout(function() {
        hljs.initHighlightingOnLoad()
    }, 1000); */
    //hljs.initHighlightingOnLoad();
    </script>
  </head>

  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-1 mr-0" href="#">Footprint v0.1</a>
      <div class="form-control form-control-dark w-100 p-0"></div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-1 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="#">
                  <span data-feather="home"></span>
                  Dashboard <span class="sr-only">(current)</span>
                </a>
              </li>
              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Vis Options</span>
              </h6>
              <li class="nav-item">
                <a class="nav-link" href="#">
                  <span data-feather="bar-chart-2"></span>
                  Render Graph
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">
                    <span data-feather="file"></span>
                    View All Log
                </a>
              </li> 
            </ul>

            <ul class="nav flex-column mb-2">
              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Debug Options</span>
              </h6>
              <li class="nav-item">
                <span class="nav-link">
                  <input type="checkbox" />&nbsp;&nbsp;Def-Use
                </span>
              </li>
              <li class="nav-item">
                <span class="nav-link">
                  <input type="checkbox" />&nbsp;&nbsp;Rank
                </span>
              </li>
            </ul>
          </div>
        </nav>

        <main role="main" class="col-md-11 ml-sm-auto col-lg-11 pt-3 px-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <div class="col-md-6">
              <h1 class="h2">CFG Panel</h1>
            </div>
            <div class="col-md-6">
              <h1 class="h2">Log Panel</h1>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6" id="cfg">
                <button id="main" style="border-radius:4px; width:40px; height:40px;"><span data-feather="home"></span></button>
                <button id="zoom_in" style="border-radius:4px; width:40px; height:40px;"><span data-feather="plus"></span></button>
                <button id="zoom_out" style="border-radius:4px; width:40px; height:40px;"><span data-feather="minus"></span></button>
            </div>
            <div class="col-md-6" id="log">
              <div class="tab" style="height:40px;">
                <button class="tablinks" onclick="changeTab(event, 'atab')" style="font-size:large; width:50%; transform:translate(0%,-13%);">Alarm</button>
                <button class="tablinks" onclick="changeTab(event, 'ltab')" style="font-size:large; width:50%; transform:translate(0%,-13%);">Log</button>
              </div>
              <div id="atab" class="tabcontent">
                <pre><code id="alarm" class="hljs cpp">
                </code></pre>
              </div>
              <div id="ltab" class="tabcontent" style="display: none; overflow-y: scroll; height: 750px;">
              </div>
            </div>
          </div>
        
        </main>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="assets/jquery-slim.min.js"><\/script>')</script> -->
    <script src="asset/popper.min.js"></script>
    <script src="asset/bootstrap.min.css"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
      feather.replace()
    </script>

    <!-- Graphs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <script>
    let width = 960;
    let height = 500;
    let cfgs = []; // 파싱된 CallGraph의 CFG 이름들

    let graph2nodes = function(gr){
    // 그래프 타입 배열을 노드 타입 배열로 변환
        let nodes = [];
        for(i in gr["nodes"]){
            nodes.push({"id":i, "stmt":gr["nodes"][i][0]});
        }
        return nodes;
    }

    let graph2cgnodes = function(gr){
    // 그래프 타입 배열을 노드 타입 배열로 변환
        let nodes = [];
        for(i in gr["nodes"]){
            nodes.push({"id":gr["nodes"][i], "stmt":gr["nodes"][i]});
        }
        return nodes;
    }

    let graph2links = function(gr){
    // 그래프 타입 배열을 링크 타입 배열로 변환
        let links = [];
        for(i in gr["edges"]){
            links.push({"source":gr["edges"][i][0], "target":gr["edges"][i][1]});
        }
        return links;
    }

    let getCfgNames = function(gr){
    // 그래프 타입 배열을 링크 타입 배열로 변환
        let names = [];
        for(i in gr["cfgs"]){
            names.push(i);
        }
        return names;
    }

    let svg = d3.selectAll("#cfg").append("svg")
      .attr("width", "100%")
      .attr("height", "800px");

    d3.json("a(cfg).json")
        .then(function(data){

          // 맨 처음 Call Graph 네트워크 그리는 부분

          cfgs = getCfgNames(data);
          let graph = data["callgraph"];
          let nodes = graph2cgnodes(graph);
          let links = graph2links(graph)

          let simulation = d3.forceSimulation()
              .nodes(nodes);                          

          simulation
              .force("charge_force", d3.forceManyBody().strength(-100))    
              .force("center_force", d3.forceCenter(width / 2, height / 2))
              .force("links", d3.forceLink(links).id(function (d) { return d.id; }))            
              .force("collide", d3.forceCollide().radius(2))
              ;         

          simulation
              .on("tick", ticked);

          //add encompassing group for the zoom 
          var g = svg.append("g")
              .attr("class", "everything");

          //Create deffinition for the arrow markers showing relationship directions
          g.append("defs").append("marker")
              .attr("id", "arrow")
              .attr("viewBox", "0 -3 10 10")
              .attr("refX", 20)
              .attr("refY", 0)
              .attr("markerWidth", 8)
              .attr("markerHeight", 8)
              .attr("orient", "auto")
              .append("svg:path")
              .attr("d", "M0,-5L10,0L0,5");        

          var link = g.append("g")
              .attr("class", "links")
              .selectAll("line")
              .data(links)
              .enter().append("line")
              .attr("stroke", function(d) { return d3.color("#000000"); })
              .attr("marker-end", "url(#arrow)");

          var node = g.append("g")
              .attr("class", "nodes")
              .selectAll("circle")
              .data(nodes)
              .enter()
              .append("circle")
              .attr("r", 10)
              .attr("fill", function(d) { 
                  console.log(d);
                  /* if (d.sourceOnly) return d3.color("#0000FF"); */
                  return d3.color("#FFFF2F"); })
              .style("stroke", function(d) { 
                  /* if (d.sourceOnly) return d3.color("#000080"); */
                  return d3.color("#FF8D2F"); 
              });

          //add drag capabilities  
          var drag_handler = d3.drag()
              .on("start", drag_start)
              .on("drag", drag_drag)
              .on("end", drag_end);	

          drag_handler(node);

          var text = g.append("g").attr("class", "labels").selectAll("g")
              .data(nodes)
              .enter().append("g")
              .append("text")
              .attr("x", 14)
              .attr("y", ".31em")
              .style("font-family", "sans-serif")
              .style("font-size", "0.7em")
              .text(function (d) { return d.stmt; });

          node.on("click", function (d) {
              d3.event.stopImmediatePropagation();
              self.onNodeClicked.emit(d.id);
          });

          node.append("title")
              .text(function (d) { return d.id + ":" + d.stmt; });
          
          var min_zoom = 0.1;
          var max_zoom = 7;

          //add zoom capabilities 
          var zoom_handler = d3.zoom().scaleExtent([min_zoom,max_zoom])
              .on("zoom", zoom_actions);

          zoom_handler(svg); 

          //Drag functions 
          //d is the node 
          function drag_start(d) {
              if (!d3.event.active) simulation.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
          }
          
          //make sure you can't drag the circle outside the box
          function drag_drag(d) {
              d.fx = d3.event.x;
              d.fy = d3.event.y;
          }
          
          function drag_end(d) {
              if (!d3.event.active) simulation.alphaTarget(0);
              d.fx = null;
              d.fy = null;
          }
          
          //Zoom functions 
          function zoom_actions(){
              g.attr("transform", d3.event.transform)
          }

          function ticked() {
              //update circle positions each tick of the simulation 
              node
                  .attr("cx", function(d) { return d.x; })
                  .attr("cy", function(d) { return d.y; });
                  
              //update link positions 
              link
                  .attr("x1", function(d) { return d.source.x; })
                  .attr("y1", function(d) { return d.source.y; })
                  .attr("x2", function(d) { return d.target.x; })
                  .attr("y2", function(d) { return d.target.y; });

              text
                  .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
          }

        });


    document.getElementById("main").onclick = function(){

        d3.json("a(cfg).json")
            .then(function(data){

            d3.selectAll("g").remove().exit().data(data);

            console.log("test1");

            cfgs = getCfgNames(data);
            let graph = data["cfgs"]["main"];        
            let nodes = graph2nodes(graph);
            let links = graph2links(graph)

            let simulation = d3.forceSimulation()
                .nodes(nodes);                          

            simulation
                .force("charge_force", d3.forceManyBody().strength(-100))    
                .force("center_force", d3.forceCenter(width / 2, height / 2))
                .force("links", d3.forceLink(links).id(function (d) { return d.id; }))            
                .force("collide", d3.forceCollide().radius(2))
                ;         

            simulation
                .on("tick", ticked);

            //add encompassing group for the zoom 
            var g = svg.append("g")
                .attr("class", "everything");

            //Create deffinition for the arrow markers showing relationship directions
            g.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", "0 -3 10 10")
                .attr("refX", 20)
                .attr("refY", 0)
                .attr("markerWidth", 8)
                .attr("markerHeight", 8)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M0,-5L10,0L0,5");        

            var link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("stroke", function(d) { return d3.color("#000000"); })
                .attr("marker-end", "url(#arrow)");

            var node = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodes)
                .enter()
                .append("circle")
                .attr("r", 10)
                .attr("fill", function(d) { 
                    /* if (d.sourceOnly) return d3.color("#0000FF"); */
                    return d3.color("#FFFF2F"); })
                //.attr("id", "1")
                .style("stroke", function(d) { 
                    /* if (d.sourceOnly) return d3.color("#000080"); */
                    return d3.color("#FF8D2F"); 
                });

            //add drag capabilities  
            var drag_handler = d3.drag()
                .on("start", drag_start)
                .on("drag", drag_drag)
                .on("end", drag_end);	

            drag_handler(node);

            var text = g.append("g").attr("class", "labels").selectAll("g")
                .data(nodes)
                .enter().append("g")
                .append("text")
                .attr("x", 14)
                .attr("y", ".31em")
                .style("font-family", "sans-serif")
                .style("font-size", "0.7em")
                .text(function (d) { return d.stmt; });

            console.log("test3");

            node.on("click", function (d) {
                d3.event.stopImmediatePropagation();
                self.onNodeClicked.emit(d.id);
            });

            node.append("title")
                .text(function (d) { return d.id + ":" + d.stmt; });
            
            var min_zoom = 0.1;
            var max_zoom = 7;

            //add zoom capabilities 
            var zoom_handler = d3.zoom().scaleExtent([min_zoom,max_zoom])
                .on("zoom", zoom_actions);

            zoom_handler(svg); 

            //Drag functions 
            //d is the node 
            function drag_start(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            //make sure you can't drag the circle outside the box
            function drag_drag(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }
            
            function drag_end(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            //Zoom functions 
            function zoom_actions(){
                g.attr("transform", d3.event.transform)
            }

            function ticked() {
                //update circle positions each tick of the simulation 
                node
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
                    
                //update link positions 
                link
                    .attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                text
                    .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
            }

        });

    }

    d3.json("memory.json")
        .then(function(data){

            for(i in data){
                console.log(data[i]);
            }

        });

    function changeTab(evt, tabName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    </script>
  </body>
</html>
