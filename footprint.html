<!doctype html>
<html lang="en">
  <head>
    <style>
    div {
        font-size: 15px;
    }
    input {
        vertical-align: middle; 
    }
    .svgbg {
        border-style: solid;
        border-width: 1px;
        border-radius: 3px;
        border-color: #ccc; 
        height: 790px;
    }
    .wrapper{
        width: 100%;        
        /* border-style: solid;
        border-width: 1px; */
        position: relative;
        /* border-radius: 3px; */
        /* border-color: #ccc; */ 
        background-color: #f0f0f0;
        padding: 20px;
        padding-top: 30px;
        border-bottom: 1px solid #ccc; 
    }
    .wrapper:hover {
        background-color: #ccc;
    }
    /* circle:hover {
        fill: #ccc;
        stroke: #d1d1d1;
    } */
    .wrapper .col-3{
        padding-left: 40px;
    }
    .arrow0 {
        fill:none;
        stroke:black;
    } 
    .arrow1 {
        fill:none;
        stroke:red;
    }
    #arrow0 {
        fill:black;
    }
    #arrow1 {
        fill:red;
    }
    #menu {
        padding: 50px;
        padding-top: 35px;
    }
    </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="http://d3js.org/d3.v5.min.js"></script>

    <title>Dashboard Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="asset/bootstrap.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="asset/dashboard.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    
    <!-- Code renderer highlight.js -->
    <link rel="stylesheet" href="asset/highlight/styles/androidstudio.css">
    <script src="asset/highlight/highlight.pack.js"></script>

    <script>
        // 알람 파일 엔트리
        /* $(document).ready(function(){
            $("#alarm").load("alarm.out");
            
            $('#log pre code').each(function(i, block) {
                hljs.highlightBlock();
            })
        }); */
    </script>
  </head>

  <body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <img width="40px" style="float:left; margin-left:10px;" src="asset/image/footprint.png">
      <a class="navbar-brand col-sm-3 col-md-1 mr-0" style="float:left; padding-left:4px;" href="#">Footprint: Visualized Debugger for Static Analyzer</a>
      <div class="form-control form-control-dark w-100 p-0"></div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-1 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="#">
                  <span data-feather="home"></span>
                  Dashboard <span class="sr-only">(current)</span>
                </a>
              </li>
              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Vis Options</span>
              </h6>
              <li class="nav-item">
                <a id="graphrender" class="nav-link" href="#">
                  <span data-feather="bar-chart-2"></span>
                  Render Graph
                </a>
              </li>
              <li class="nav-item">
                <a id="readalarm" class="nav-link" href="#">
                  <span data-feather="check"></span>
                  Read Alarm 
                </a>
              </li>
              <li class="nav-item">
                <a id="viewlog" class="nav-link" href="#">
                    <span data-feather="file"></span>
                    View All Log
                </a>
              </li> 
            </ul>

            <ul class="nav flex-column mb-2">
              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Debug Options</span>
              </h6>
              <li class="nav-item">
                <span class="nav-link" style="margin-bottom:-10px;">
                  <label><input id="dugchk" type="checkbox" onclick="toggleDug()" />&nbsp;&nbsp;Def-Use</label>
                </span>
              </li>
              <!-- <li class="nav-item">
                <span class="nav-link" style="margin-bottom:-10px;">
                  <label><input type="checkbox" />&nbsp;&nbsp;Rank</label>
                </span>
              </li> -->
              <li class="nav-item">
                <span class="nav-link">
                  <label><input id="foldchk" type="checkbox" onclick="toggleFold(event)" />&nbsp;&nbsp;Fold Log</label>
                </span>
              </li>
            </ul>
          </div>
        </nav>

        <main role="main" class="col-md-11 ml-sm-auto col-lg-11 pt-3 px-4">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom" style="margin-left:-15px;">
            <div class="col-md-6">
              <h1 class="h2">CFG Panel</h1>
            </div>
            <div class="col-md-6" style="margin-left:15px;">
              <h1 class="h2">Log Panel</h1>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 svgbg" id="cfg">
                <button id="home" style="border-radius:4px; width:40px; height:40px; margin-top:15px;"><span data-feather="home"></span></button>
                <!-- <button id="zoom_in" style="border-radius:4px; width:40px; height:40px; margin-top:15px;"><span data-feather="plus"></span></button>
                <button id="zoom_out" style="border-radius:4px; width:40px; height:40px; margin-top:15px;"><span data-feather="minus"></span></button> -->
                <div id="dugon" style="float:right; border-radius:4px; background-color:#eee; border-color:#ccc; border-style:solid; border-width:1px; width:130px; height:50px; margin-top:15px; padding-left:5px; display:none;">
                    <span data-feather="arrow-right"></span>&nbsp;Control Flow</br>
                    <span data-feather="arrow-right" style="color:red;"></span>&nbsp;<span style="color:red;">Def-Use Chain</span>
                </div>
                <div id="dugoff" style="float:right; border-radius:4px; background-color:#eee; border-color:#ccc; border-style:solid; border-width:1px; width:130px; height:28px; margin-top:15px; padding-left:5px; display:inline;">
                    <span data-feather="arrow-right"></span>&nbsp;Control Flow</br>
                </div>
            </div>
            <div class="col-md-6" id="log">
              <div class="tab" style="height:40px;">
                <button class="tablinks" onclick="changeTab(event, 'atab')" style="font-size:large; width:50%; transform:translate(0%,-13%);">Alarm</button>
                <button class="tablinks" onclick="changeTab(event, 'ltab')" style="font-size:large; width:50%; transform:translate(0%,-13%);">Log</button>
              </div>
              <div id="atab" class="tabcontent" style="display: none;">
                <pre><code id="alarm" class="hljs">
                </code></pre>
              </div>
              <div id="ltab" class="tabcontent" style="overflow-y: scroll; height: 750px; border-left: solid 1px #ccc; border-right: solid 1px #ccc; border-bottom: solid 1px #ccc; border-radius: 3px;">
                <div id="unfolded" class="foldcontent">
                </div>
                <div id="folded" class="foldcontent" style="display: none;">
                    <div id="menu">
                        <p><b>NODE</b></p>
                        <select class="custom-select" id="nodes" onchange= "changeNode(this.value)" style="margin-bottom: 20px; height: 30px;"></select>
                        <p><b>INPUT</b></p>
                        <div id="tb_input"></div>
                        <p style="margin-top: 10px;"><b>OUTPUT</b></p>
                        <div id="tb_output">
                    </div>
                <div>
              </div>
            </div>
          </div>
        
        </main>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="assets/jquery-slim.min.js"><\/script>')</script> -->
    <script src="asset/popper.min.js"></script>
    <script src="asset/bootstrap.min.css"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
      feather.replace()
    </script>

    <script>
    $( ".row .wrapper" ).click(function() {
        alert( "Handler for .click() called." );
    });
    </script>

    <!-- Graphs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
    <script>
    let width = 960;
    let height = 500;
    let cfgs = []; // 파싱된 CallGraph의 CFG 이름들
    let cfgStatus; // 현재 CFG Panel에 렌더링하고 있는 그래프 이름. (CallGraph는 cg)

    function readTextFile(file)
    // 외부 텍스트 파일 읽기 함수
    {
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", file, false);
        rawFile.onreadystatechange = function ()
        {
            if(rawFile.readyState === 4)
            {
                if(rawFile.status === 200 || rawFile.status == 0)
                {
                    var allText = rawFile.responseText;
                    allText = allText.replace("@", "<textarea><br></textarea>");
                    document.getElementById('alarm').innerText = allText;
                    //hljs.initHighlighting.called = false;
                    //hljs.initHighlighting();
                }
            }
        }
        rawFile.send(null);
    }

    let graph2nodes = function(gr){
    // 그래프 타입 배열을 노드 타입 배열로 변환
        let nodes = [];
        for(i in gr["nodes"]){
            nodes.push({"id":i, "stmt":gr["nodes"][i][0]});
        }
        return nodes;
    }

    let graph2cgnodes = function(gr){
    // 그래프 타입 배열을 노드 타입 배열로 변환
        let nodes = [];
        for(i in gr["nodes"]){
            nodes.push({"id":gr["nodes"][i], "stmt":gr["nodes"][i]});
        }
        return nodes;
    }

    let graph2links = function(gr){
    // 그래프 타입 배열을 링크 타입 배열로 변환
        let links = [];
        for(i in gr["edges"]){
            links.push({"source":gr["edges"][i][0], "target":gr["edges"][i][1], "text":""});
        }
        return links;
    }

    let getCfgNames = function(gr){
    // 그래프 타입 배열을 링크 타입 배열로 변환
        let names = [];
        for(i in gr["cfgs"]){
            names.push(i);
        }
        return names;
    }

    let hasCfgName = function(cfgs, cname){
    // CFG 이름 리스트에서 cname이 존재하는지 확인
        for(i in cfgs){
            if(cfgs[i]===cname) return true;
        }
        return false;
    }

    let svg = d3.selectAll("#cfg").append("svg")
      .attr("width", "100%")
      .attr("height", "720px");

    let dugOn; // Def-Use 토글 옵션 체크박스
    let foldOn; // 로그 폴딩 옵션 체크박스

    readTextFile("analysis_result/recipient.txt");

    d3.json("demo/long/a.json")
        .then(function(data){
            // 초기 데이터 엔트리
            renderCfg(data, "cg", false);
        });

    // CFG 그래프 렌더링 용 변수들
    let graph;
    let nodes;
    let links;
    let simulation;

    let g;
    let link;
    let node;

    let drag_handler;
    let text;

    // 줌 관련 렌더링 변수들
    let min_zoom;
    let max_zoom;
    let zoom_handler;

    let getDugChain = function(data, cid){
        let dugChain = data["dugraph"]["edges"];
        let curChain = [];
        for(i in dugChain){
            if(dugChain[i][0].substring(0, cid.length) === cid && dugChain[i][1].substring(0, cid.length) === cid){
            // DUG 체인이 현재 렌더링된 그래프에 해당될 때
                let src = dugChain[i][0].substring(dugChain[i][0].indexOf('\-')+1);
                let tgt = dugChain[i][1].substring(dugChain[i][1].indexOf('\-')+1);
                let txt = dugChain[i][2];
                curChain.push({"source":src, "target":tgt, "text":txt});
            }
        }
        return curChain;
    }

    let renderCfg = function(data, cid, dugbtn){

        cfgStatus = cid; // 해당 선택된 CFG 렌더링

        d3.selectAll("g").remove().exit().data(data);

        cfgs = getCfgNames(data);
        if(cid === "cg") {
            graph = data["callgraph"];
            nodes = graph2cgnodes(graph);
        } else { 
            graph = data["cfgs"][cid];        
            nodes = graph2nodes(graph);
        }
        links = graph2links(graph)
        if(dugbtn === true){
            let duLst = getDugChain(data, cid);
            links = links.concat(duLst);
        }

        simulation = d3.forceSimulation()
            .nodes(nodes);                          

        simulation
            .force("charge_force", d3.forceManyBody().strength(-100))    
            .force("center_force", d3.forceCenter(width / 2, height / 2))
            .force("links", d3.forceLink(links).id(function (d) { 
                return d.id; }))            
            .force("collide", d3.forceCollide().radius(2));         

        simulation
            .on("tick", ticked);        

        //add encompassing group for the zoom 
        g = svg.append("g")
            .attr("class", "everything");

        //Create deffinition for the arrow markers showing relationship directions
        g.append("defs").append("marker")
            .attr("id", "arrow0")
            .attr("viewBox", "0 -3 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("markerWidth", 8)
            .attr("markerHeight", 8)
            .attr("orient", "auto")
            .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");        

        g.append("defs").append("marker")
            .attr("id", "arrow1")
            .attr("viewBox", "0 -3 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("markerWidth", 8)
            .attr("markerHeight", 8)
            .attr("orient", "auto")
            .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");        

        link = g.append("g")
            .attr("class", "links")
            .selectAll("path")
            .data(links)
            .enter().append("path")
            .attr("class", function(d) {
                if(d.text === "") return "arrow0";
                else return "arrow1"; })
            .attr("stroke", function(d) { 
                if(d.text === "") return d3.color("#000000");
                else return d3.color("#FF0000"); })
            .attr("marker-end", function(d) { 
                if(d.text === "") return "url(#arrow0)";
                else return "url(#arrow1)"; });
            //#arrow" + d["value"] + "

        node = g.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("circle")
            .attr("id", function(d) { 
                return cfgStatus + "-" + d.id;
            })
            .attr("r", 10)
            .attr("fill", function(d) { 
                /* if (d.sourceOnly) return d3.color("#0000FF"); */
                return d3.color("#FFFF2F"); })
            //.attr("id", "1")
            .attr("stroke", function(d) { 
                /* if (d.sourceOnly) return d3.color("#000080"); */
                return d3.color("#FF8D2F"); 
            });

        //add drag capabilities  
        drag_handler = d3.drag()
            .on("start", drag_start)
            .on("drag", drag_drag)
            .on("end", drag_end);	

        drag_handler(node);

        text = g.append("g").attr("class", "labels").selectAll("g")
            .data(nodes)
            .enter().append("g")
            .append("text")
            .attr("x", 14)
            .attr("y", ".31em")
            .style("font-family", "sans-serif")
            .style("font-size", "0.7em")
            .text(function (d) { 
                if(d.id === "ENTRY" || d.id === "EXIT") return d.id + ":" + d.stmt;
                else return d.stmt; });

        node.on("click", function (d) {
            
            if(hasCfgName(cfgs, d.id)){
                let dugOn = document.getElementById("dugchk");
                d3.json("demo/long/a.json")
                .then(function(data){
                    renderCfg(data, d.id, dugOn.checked);
                });
            } else {
                d3.event.stopImmediatePropagation();
                console.log("node click "+cfgStatus + "-" + d.id);
                changeNode(cfgStatus + "-" + d.id);
                
                var val = cfgStatus + "-" + d.id;
                var sel = document.getElementById('nodes');
                var opts = sel.options;
                for (var opt, j = 0; opt = opts[j]; j++) {
                  if (opt.value == val) {
                    sel.selectedIndex = j;
                    console.log(opt.value);
                    break;
                  }
                }

                self.onNodeClicked.emit(d.id);   
            }
            
        });

        node.append("title")
            .text(function (d) { return d.id + ":" + d.stmt; });
        
        min_zoom = 0.5;
        max_zoom = 5;

        //add zoom capabilities 
        zoom_handler = d3.zoom().scaleExtent([min_zoom,max_zoom])
            .on("zoom", zoom_actions);

        zoom_handler(svg); 

        //Drag functions 
        //d is the node 
        function drag_start(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        //make sure you can't drag the circle outside the box
        function drag_drag(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }
        
        function drag_end(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        //Zoom functions 
        function zoom_actions(){
            g.attr("transform", d3.event.transform)
        }

        function ticked() {
            //update circle positions each tick of the simulation 
            node
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
                
            //update link positions 
            /* link
                .attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; }); */

            link.attr("d", function(d) {
                var dx = d.target.x - d.source.x,
                    dy = d.target.y - d.source.y,
                    dr;  //linknum is defined above
                    if(d.text === "") dr = 0;
                    else dr = 50;
                return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
            });

            text
                .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });
        }


    }


    document.getElementById("viewlog").onclick = function() {
        changeTab(window.event, 'ltab');
    };

    document.getElementById("readalarm").onclick = function() {
        changeTab(window.event, 'atab');
    };

    document.getElementById("graphrender").onclick = function() {
        // 초기 CallGraph 렌더링하기

        cfgStatus = "cg";        
        dugOn = document.getElementById("dugchk");

        d3.json("demo/long/a.json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, "cg", dugOn.checked);
            });

    };

    document.getElementById("home").onclick = function() {
        // 초기 CallGraph 렌더링하기
        cfgStatus = "cg";        
        dugOn = document.getElementById("dugchk");

        d3.json("demo/long/a.json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, "cg", dugOn.checked);
            });

    };

    let divClick = function() {
        console.log("1");
        console.log(this.id);
    }

    // 초기 로그 탭 켜놓기
    document.getElementById("ltab").style.display = "block";

    function changeTab(evt, tabName) {
        // HTML 패널 전환 이벤트 함수
        var i, tabcontent, tablinks;

        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function toggleDug() {
        // 체크박스 확인해서 텍스트 박스 켜고 끔
        dugOn = document.getElementById("dugchk");
        let dugOnTxt = document.getElementById("dugon");
        let dugOffTxt = document.getElementById("dugoff");

        if (dugOn.checked == true){
            dugOnTxt.style.display = "inline";
            dugOffTxt.style.display = "none";

            d3.json("demo/long/a.json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, cfgStatus, true);
            });

        } else {
            dugOnTxt.style.display = "none";
            dugOffTxt.style.display = "inline";

            d3.json("demo/long/a.json")
            .then(function(data){
                d3.selectAll("g").remove().exit().data(data);
                renderCfg(data, cfgStatus, false);
            });

        }
    }

    function toggleFold(evt) {
        // 체크박스 확인해서 로그 폴딩 속성 켜고 끔
        foldOn = document.getElementById("foldchk");
        let foldId;

        if (foldOn.checked == true){
            foldId = "folded";
        } else {
            foldId = "unfolded";
        }

        let i, foldcontent, foldlinks;

        foldcontent = document.getElementsByClassName("foldcontent");
        for (i = 0; i < foldcontent.length; i++) {
            foldcontent[i].style.display = "none";
        }

        foldlinks = document.getElementsByClassName("foldlinks");
        for (i = 0; i < foldlinks.length; i++) {
            foldlinks[i].className = foldlinks[i].className.replace(" active", "");
        }

        document.getElementById(foldId).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // 메모리 로깅 관련 구현부
    // TODO: 로깅 확장
    /* d3.json("memory.json")
    .then(function(data){
        for(i in data){
            let keys = d3.keys(data[i]);
            let vals = d3.values(data[i]);
            let div = document.createElement('div');
            
            div.className = 'row wrapper';
            div.id = vals[0];
            div.style.marginLeft = '0px';
            div.innerHTML = "";

            if(i == data.length-1) div.style.borderBottom = "0px";

            for(j in keys){
                keys[j][0] = keys[j][0].toUpperCase();
                div.innerHTML +=
                    '<div class="col-3"><b>'+keys[j].toUpperCase()+'</b><hr></div><div class="col-9">'+vals[j]+'<hr></div>';
            }
            document.getElementById('unfolded').appendChild(div);
        }
    }); */

    d3.json("table4.json")
  .then(d => {
    // preprocess the memories (make v as one string)
    data = d.map(row => {
      return {
        node: row.node,
        input: preprocessMem(row.input),
        output: preprocessMem(row.output)
      };
    });
    //console.log("inputMem:")
    // get list of nodes
    const nodeList = d.map(row => row.node);
    return nodeList;
  })
  .then(nodeList => {
    // load node into drop-down
    d3.select("#menu select")
      .selectAll("option")
      .data(nodeList)
      .enter()
      .append("option")
      .attr("value", d => d)
      .text(t => t);
    return nodeList[0];
  }).then(node => {
    data.map(node => {
    
    let keys = d3.keys(data[i]);
    let vals = d3.values(data[i]);
    let div = document.createElement('div');
    
    div.className = 'row wrapper';
    div.id = node.node;
    div.style.marginLeft = '0px';
    div.onclick = function() { 
      let dugOn = document.getElementById("dugchk");
      let fname = node.node.substring(0, node.node.indexOf('-'));
      d3.json("demo/long/a.json")
      .then(function(data){
          renderCfg(data, fname, dugOn.checked);
      });
    };
    div.onmouseover = function() {
      // TODO:
      if(cfgStatus == "cg"){
        document.getElementById("cg-"+node.node.substring(0, node.node.indexOf('-'))).style.fill = "#0000FF";
        document.getElementById("cg-"+node.node.substring(0, node.node.indexOf('-'))).style.stroke = "#000080";
      } else {
        document.getElementById(node.node).style.fill = "#0000FF";
        document.getElementById(node.node).style.stroke = "#000080";
      }
    };
    div.onmouseout = function() {
      // TODO:
      if(cfgStatus == "cg"){
        document.getElementById("cg-"+node.node.substring(0, node.node.indexOf('-'))).style.fill = "#FFFF2F";
        document.getElementById("cg-"+node.node.substring(0, node.node.indexOf('-'))).style.stroke = "#FF8D2F";
      } else {
        document.getElementById(node.node).style.fill = "#FFFF2F";
        document.getElementById(node.node).style.stroke = "#FF8D2F";
      }
    };
    div.innerHTML = "";

    if(i == data.length-1) div.style.borderBottom = "0px";

  //console.log("=================Node:"+node.node+"=======================");
  div.innerHTML +=
            '<div class="col-3"><b>NODE</b><hr></div><div class="col-9">'+node.node+'<hr></div>';

  //console.log("=================Input==================");
  let inputTxt = "";

  node.input.map(row => {
  
   //console.log("value: "+row.loc + " -> " + row.v);
   inputTxt += "value: "+row.loc + " -> " + row.v + "<br>";
   //console.log("fps:")
   inputTxt += "fps: ";
    for (let i in row.fps ){
     if (row.fps[i].AddrOf) 
     {//console.log(__valueToString(row.fps[i]));
        inputTxt += __valueToString(row.fps[i]);
    }
     else {
         //console.log(_valueToString(row.fps[i].v) + "," + row.fps[i].exp + "," + row.fps[i].pgm_point);
         inputTxt += _valueToString(row.fps[i].v) + "," + row.fps[i].exp + "," + row.fps[i].pgm_point;
     }
   }

 //console.log("---------------------------");
 })
 div.innerHTML +=
            '<div class="col-3"><b>INPUT</b><hr></div><div class="col-9">'+inputTxt+'<hr></div>';

 //console.log("=================Output===============");
 let outputTxt = "";
 node.output.map(row => {
 
  //console.log("value: "+row.loc + " -> " + row.v);
  outputTxt += "value: "+row.loc + " -> " + row.v + "<br>";
  //console.log("fps:")
  outputTxt += "fps: ";
   for (let i in row.fps ){
    if (row.fps[i].AddrOf) 
    {//console.log(__valueToString(row.fps[i]));
        outputTxt += __valueToString(row.fps[i]);
    }
    else {
        //console.log(_valueToString(row.fps[i].v) + "," + row.fps[i].exp + "," + row.fps[i].pgm_point);
        outputTxt += _valueToString(row.fps[i].v) + "," + row.fps[i].exp + "," + row.fps[i].pgm_point;
    }
  }
 
//console.log("---------------------------");
})
  div.innerHTML +=
            '<div class="col-3"><b>OUTPUT</b><hr></div><div class="col-9">'+outputTxt+'<hr></div>';

  document.getElementById('unfolded').appendChild(div);


 //console.log("-----");
});
return node;
  })
  .then(node => {
    //renderTable(node);
  });
    // =======================================
    // ======== Json 메모리 파싱 구현부 ==========
    // =======================================

    //modification to https://stackoverflow.com/questions/36273346/d3js-creating-a-collapsible-table-issues-with-nested-data

    let tableWidth = 400,
  tableHeight = 1000,
  barHeight = 40,
  barWidth = tableWidth * 1,
  duration = 300;

let outputSvg = d3
  .select("#tb_output")
  .append("div")
  .classed("svg-container", true)
  .append("svg")
  .classed("table-svg", true)
  .attr("preserveAspectRatio", "xMinYMin meet")
  .attr("viewBox", "0 0 " + tableWidth + " " + tableHeight);

let inputSvg = d3
  .select("#tb_input")
  .append("div")
  .classed("svg-container", true)
  .append("svg")
  .classed("table-svg", true)
  .attr("preserveAspectRatio", "xMinYMin meet")
  .attr("viewBox", "0 0 " + tableWidth + " " + tableHeight);

function updateInputTable(source) {
  //console.log("----------");
  let x0 = 0,
    y0 = 0,
    barHeight = 20,
    padding = 1,
    shownChildren = [];

  source.forEach(function(d) {
    d.x = x0;
    d.y = y0;
    let parentX = x0,
      parentY = y0;
    y0 += barHeight + padding;
    if (d.fps) {
      d.fps.forEach(function(data) {
        data.x = x0;
        data.y = y0;
        data.parentX = parentX;
        data.parentY = parentY;
        // y0 += barHeight + padding;
        y0 += data.AddrOf
          ? barHeight + 30 + padding
          : _valueToString(data.v).length > 120
          ? barHeight + 10 + padding
          : barHeight + padding;
        shownChildren.push(data);
      });
    } else if (d._fps) {
      d._fps.forEach(function(data) {
        data.x = parentX;
        data.y = parentY;
        data.parentX = parentX;
        data.parentY = parentY;
        shownChildren.push(data);
      });
    }
  });

  inputSvg
    .transition()
    .duration(duration)
    .attr("viewBox", "0 0 " + tableWidth + " " + y0);

  d3.select(self.frameElement)
    .transition()
    .duration(duration)
    .style("height", tableHeight + "px");

  //console.log(shownChildren);
  let childRow = inputSvg.selectAll(".children").data(shownChildren);

  let childEnter = childRow
    .enter()
    .append("g", ":first-child")
    .classed("children", true)
    .attr("transform", function(d) {
      //console.log("Child Enter: " + d.v + "," + d.y);
      return "translate(" + d.parentX + "," + d.parentY + ")";
    });

  let childRect = childEnter
    .append("rect")
    .attr("height", function(d) {
      if (d.AddrOf) return barHeight + 30;
      else if (_valueToString(d.v).length > 120) return barHeight + 10;
      else return barHeight;
    })
    .attr("width", barWidth)
    .style("fill", color);

  let childText = childEnter
    .append("text")
    .attr("dy", 15)
    .attr("dx", 5.5)
    .style("font-size", "8px")
    .html(function(d) {
      if (d.AddrOf) return make_tspan(__valueToString(d));
      else {
        return make_tspan(
          _valueToString(d.v) + "," + d.exp + "," + d.pgm_point
        );
      }
    });

  

  // Transition nodes to their new position.
  childEnter
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      console.log("Child Enter Transition: " + d.v + "," + d.y);
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1);

  childRow
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      console.log("Child Row Transition: " + d.loc + "," + d.y);
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1)
    .select("rect")
    .style("fill", color);

  // Transition exiting nodes to the parent's new position.
  /*childRow.exit().transition()
    .duration(duration)
    .attr("transform", function(d) {
      return "translate(" + d.parentX + "," + d.parentY + ")";
    })
    .style("opacity", 1e-6)
    .remove();*/

  let tableRow = inputSvg.selectAll(".tableRow").data(source);

  let rowEnter = tableRow
    .enter()
    .append("g")
    .classed("tableRow", true)
    .attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });

  let rowRect = rowEnter
    .append("rect")
    .attr("height", barHeight)
    .attr("width", barWidth)
    .style("fill", color)
    .on("click", click);

  // value to string for v
  function valueToString(v) {
    let print_arrayblk = function(v) {
      if (v.arrblk === "bot") return v.arrblk;
      else {
        return (
          "{" +
          v.arrblk.allocsite +
          " -> (" +
          v.arrblk.arrinfo[0] +
          "," +
          v.arrblk.arrinfo[1] +
          "," +
          v.arrblk.arrinfo[2] +
          "," +
          v.arrblk.arrinfo[3] +
          ", " +
          v.arrblk.arrinfo[4] +
          ")}"
        );
      }
    };

    return (
      "(" +
      v.itv +
      "," +
      v.powloc +
      "," +
      print_arrayblk(v) +
      "," +
      v.structblk +
      "," +
      v.powproc +
      ")"
    );
  }

  let rowText = rowEnter
    .append("text")
    .attr("dy", 15)
    .attr("dx", 5.5)
    .style("font-size", "8px")
    .text(function(d) {
      return d.loc + " -> " + d.v;
    })
    .on("click", click);

  rowEnter
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1);

  tableRow
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1)
    .select("rect")
    .style("fill", color);

  function click(d) {
    if (d.fps) {
      d._fps = d.fps;
      d.fps = null;
    } else {
      d.fps = d._fps;
      d._fps = null;
    }
    updateInputTable(source);
  }

  function color(d) {
    return d._fps ? "#ccc" : d.fps ? "#eee" : "#f2dca7";
  }
}

function updateOutputTable(source) {
  //console.log("----------");
  let x0 = 0,
    y0 = 0,
    barHeight = 20,
    padding = 1,
    shownChildren = [];

  source.forEach(function(d) {
    d.x = x0;
    d.y = y0;
    let parentX = x0,
      parentY = y0;
    y0 += barHeight + padding;
    if (d.fps) {
      d.fps.forEach(function(data) {
        data.x = x0;
        data.y = y0;
        data.parentX = parentX;
        data.parentY = parentY;
        // y0 += barHeight + padding;
        y0 += data.AddrOf
          ? barHeight + 30 + padding
          : _valueToString(data.v).length > 120
          ? barHeight + 10 + padding
          : barHeight + padding;
        shownChildren.push(data);
      });
    } else if (d._fps) {
      d._fps.forEach(function(data) {
        data.x = parentX;
        data.y = parentY;
        data.parentX = parentX;
        data.parentY = parentY;
        shownChildren.push(data);
      });
    }
  });

  outputSvg
    .transition()
    .duration(duration)
    .attr("viewBox", "0 0 " + tableWidth + " " + y0);

  d3.select(self.frameElement)
    .transition()
    .duration(duration)
    .style("height", tableHeight + "px");

  //console.log(shownChildren);
  let childRow = outputSvg.selectAll(".children").data(shownChildren);

  let childEnter = childRow
    .enter()
    .append("g", ":first-child")
    .classed("children", true)
    .attr("transform", function(d) {
      //console.log("Child Enter: " + d.v + "," + d.y);
      return "translate(" + d.parentX + "," + d.parentY + ")";
    });

  let childRect = childEnter
    .append("rect")
    .attr("height", function(d) {
      if (d.AddrOf) return barHeight + 30;
      else if (_valueToString(d.v).length > 120) return barHeight + 10;
      else return barHeight;
    })
    .attr("width", barWidth)
    .style("fill", color);

  let childText = childEnter
    .append("text")
    .attr("dy", 15)
    .attr("dx", 5.5)
    .style("font-size", "8px")
    .html(function(d) {
      if (d.AddrOf) return make_tspan(__valueToString(d));
      else {
        return make_tspan(
          _valueToString(d.v) + "," + d.exp + "," + d.pgm_point
        );
      }
    });

  

  // Transition nodes to their new position.
  childEnter
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      //console.log("Child Enter Transition: " + d.v + "," + d.y);
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1);

  childRow
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      //console.log("Child Row Transition: " + d.loc + "," + d.y);
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1)
    .select("rect")
    .style("fill", color);

  let tableRow = outputSvg.selectAll(".tableRow").data(source);

  let rowEnter = tableRow
    .enter()
    .append("g")
    .classed("tableRow", true)
    .attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });

  let rowRect = rowEnter
    .append("rect")
    .attr("height", barHeight)
    .attr("width", barWidth)
    .style("fill", color)
    .on("click", click);

  // value to string for v
  function valueToString(v) {
    let print_arrayblk = function(v) {
      if (v.arrblk === "bot") return v.arrblk;
      else {
        return (
          "{" +
          v.arrblk.allocsite +
          " -> (" +
          v.arrblk.arrinfo[0] +
          "," +
          v.arrblk.arrinfo[1] +
          "," +
          v.arrblk.arrinfo[2] +
          "," +
          v.arrblk.arrinfo[3] +
          ", " +
          v.arrblk.arrinfo[4] +
          ")}"
        );
      }
    };

    return (
      "(" +
      v.itv +
      "," +
      v.powloc +
      "," +
      print_arrayblk(v) +
      "," +
      v.structblk +
      "," +
      v.powproc +
      ")"
    );
  }

  let rowText = rowEnter
    .append("text")
    .attr("dy", 15)
    .attr("dx", 5.5)
    .style("font-size", "8px")
    .text(function(d) {
      return d.loc + " -> " + d.v;
    })
    .on("click", click);

  rowEnter
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1);

  tableRow
    .transition()
    .duration(duration)
    .attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    })
    .style("opacity", 1)
    .select("rect")
    .style("fill", color);

  function click(d) {
    if (d.fps) {
      d._fps = d.fps;
      d.fps = null;
    } else {
      d.fps = d._fps;
      d._fps = null;
    }
    updateOutputTable(source);
  }

  function color(d) {
    return d._fps ? "#ccc" : d.fps ? "#eee" : "#f2dca7";
  }
}


/*******************************************************************************
* Common functions for update memory
*******************************************************************************/

//value to string for fps
function _valueToString(v) {
  let str_arr = function(v) {
    if (v.Arrsite === "bot") return "bot";
    else {
      return "{" + v.Arrsite + "-> " + v.arrinfo + "}";
    }
  };

  let str_blk = function(v) {
    if (v.Structsite === "bot") return "bot";
    else return "{" + v.Structsite + "->" + v.structinfo + "}";
  };

  return (
    "(" +
    v.itv +
    "," +
    v.loc +
    "," +
    str_arr(v) +
    "," +
    str_blk(v) +
    "," +
    v.powproc +
    ")"
  );
}

// for fps with AddrOf 
function __valueToString(d) {
  let print = function(d) {
    if (d.Parent)
      _valueToString(d.v) +
        "," +
        d.exp +
        "," +
        d.pgm_point +
        "\n" +
        "Parent:" +
        print(d.Parent[0]);
    else return _valueToString(d.v) + "," + d.exp + "," + d.pgm_point;
  };
  return (
    _valueToString(d.v) +
    "," +
    d.exp +
    "," +
    d.pgm_point +
    "\n" +
    "ArrdOf:" +
    _valueToString(d.AddrOf.v) +
    "," +
    d.AddrOf.exp +
    "," +
    d.AddrOf.pgm_point +
    "\n" +
    "Parent:" +
    print(d.AddrOf.Parent[0])
  );
}

function make_tspan(str) {
  let str_split = str.split("\n");
  let process_str = function(str) {
    if (str.length < 120) return "<tspan x=0 dy=1.2em>" + str + "</tspan>";
    else {
      let _str = str;
      let result = "";
      while (_str.length > 120) {
        result +=
          "<tspan x=0 dy=1.2em>" + _str.substring(0, 120) + "</tspan>";
        _str = _str.substring(120, _str.length);
      }
      result += "<tspan x=0 dy=1.2em>" + _str + "</tspan>";
      // let result =  "<tspan x=0 dy=1.2em>" + str.substring(0, 120) + "</tspan>" +
      //   "<tspan x=0 dy=1.2em>" + str.substring(120, str.length) + "</tspan>";
      return result;
    }
  };

  let result = "";
  for (let i in str_split) {
    result += process_str(str_split[i]);
  }

  return result;
}


function sortFps(fps) {
  let compare_by_order = (fp1, fp2) => parseInt(fp2.o) - parseInt(fp1.o);
  let compare_by_priority = (fp1, fp2) => {
    let max = (a, b) => (a < b ? b : a);
    let _calc_priority = fp => {
      if (!fp.Parent) return parseInt(fp.p);
      else return max(parseInt(fp.p), _calc_priority(fp.Parent));
    };
    let calc_priority = fp => {
      if (!fp.AddrOf) return parseInt(fp.p);
      else {
        if (!fp.AddrOf.Parent) {
          return max(parseInt(fp.p), parseInt(fp.AddrOf.p));
        } else {
          return max(parseInt(fp.p), _calc_priority(fp.AddrOf.Parent));
        }
      }
    };
    return calc_priority(fp2) - calc_priority(fp1);
  };
  return fps.sort(compare_by_order).sort(compare_by_priority);
}

function changeNode(node) {
  inputSvg.selectAll("*").remove();
  outputSvg.selectAll("*").remove();
  renderTable(node);
}

function renderTable(node) {
  node = data.find(d => {
    return d.node === node;
  });
  input = node.input;
  output = node.output;
  input.forEach(function(d) {
    if (d.fps) {
      d._fps = d.fps;
      d.fps = null;
    } else {
      d.fps = d._fps;
      d._fps = null;
    }
  });
  updateInputTable(input);

  output.forEach(function(d) {
    if (d.fps) {
      d._fps = d.fps;
      d.fps = null;
    } else {
      d.fps = d._fps;
      d._fps = null;
    }
    updateOutputTable(output);
  });
}


/*******************************************************************************
* Preprocess Memory
*******************************************************************************/
let valueToString = function(v) {
  let str_arrayblk = function(arr) {
    if (arr === "bot") return arr;
    else {
      return (
        "{" +
        arr.allocsite +
        " -> (" +
        arr.arrinfo[0] +
        "," +
        arr.arrinfo[1] +
        "," +
        arr.arrinfo[2] +
        "," +
        arr.arrinfo[3] +
        ", " +
        arr.arrinfo[4] +
        ")}"
      );
    }
  };

  let str_structblk = function(x) {
    if (x === "bot") return x;
    else return "{" + x.loc + "->" + x.structinfo + "}";
  };

  return (
    "(" +
    v.itv +
    "," +
    v.powloc +
    "," +
    str_arrayblk(v.arrblk) +
    "," +
    str_structblk(v.structblk) +
    "," +
    v.powproc +
    ")"
  );
};

//convert value record to single string
function preprocessMem(mem) {
  let bot_fp = [
    {
      v: {
        itv: "bot",
        loc: "bot",
        Arrsite: "bot",
        arrinfo: ["bot", "bot", "bot", "bot", "bot"],
        structblk: "bot",
        powproc: "bot"
      },
      exp: "bot",
      pgm_point: "bot",
      o: "-1",
      p: "-1"
    }
  ];

  return mem.map(row => {
    if (row === "bot") {
      return { loc: "bot", v: "bot", fps: bot_fp };
    } else {
      return {
        loc: row.loc,
        v: valueToString(row.v),
        fps: row.fps[0] === "bot" ? bot_fp : sortFps(row.fps)
      };
    }
  });
}


    </script>
  </body>
</html>
